{% extends 'base.html' %}
<!---->
{% load humanize %}
<!---->
{% load static %}
<!---->
{% block title %} | 我的購買紀錄 {% endblock %}
<!---->
{% block content %}
<div class="card shadow-sm mt-4">
  <div class="card-header bg-white font-weight-bold">我的購買紀錄</div>
  <div class="card-body">
    {% if orders %} {% for order in orders %}
    <div class="border rounded p-3 mb-3">
      <div class="d-flex flex-column align-items-end mb-2">
        <div class="d-flex align-items-center mb-1">
          <h6 class="font-weight-bold text-primary mb-0 mr-2">
            訂單編號: #{{ order.id }}
          </h6>
          <span
            class="badge.badge-{% if order.status == 'Pending' %}warning{% else %}success {% endif%}"
          >
            {{ order.status }}
          </span>
        </div>
        <div class="text-muted small">
          <span>提貨方法: {{ order.get_delivery_method_display }}</span>
        </div>
        <!-- "Choice Display Methods" :Model 嘅Field define咗 choices ,django會自動幫models 生成一個'隱藏'嘅 Function-->
        <!-- 用法：get_ + [欄位名稱] + _display-->
        <!--用 order.delivery_method：-->
        <!--會係 Database 攞值，顯示出嚟會係：BOOTH。-->
        <!--用 order.get_delivery_method_display() (或者 Template 嘅 {{ order.get_delivery_method_display }})：-->
        <!--會對返個 choices 清單，顯示出嚟會係：下次 Booth 自取。-->
      </div>
      <div class="small text-muted mb-2">
        下單時間: {{ order.created_at|date:"Y-m-d H:i" }}
      </div>
      <ul class="list-unstyled">
        {% for item in order.items.all %}
        <lu
          class="small d-flex justify-content-between border-bottom pb-2 mb-2"
        >
          <div class="">
            <div class="font-weight-bold">
              {{ item.product.title }} x {{ item.quantity }}
            </div>
            <div class="text-muted">
              <strong>尺寸:</strong>
              {% if item.size == '0' or item.size == 0 or not item.size %}
              <!---->
              Standard
              <!---->
              {% else %}{{ item.size}}{% endif %}
              <span class="mx-2">|</span>
              <strong>單價:</strong>HK${{ item.price|intcomma }}
            </div>
          </div>
          <div class="align-self-center font-weight-bold text-danger">
            HK${{ item.get_subtotal|intcomma }}
          </div>
        </lu>
        {% endfor %}
      </ul>
      <!-- -->
      <hr />
      <div class="text-right font-weight-bold mb-3">
        總計: HK${{ order.total_price|intcomma }}
      </div>
      <div class="mt-3 p-3 bg-light rounded shadow-sm">
        {% if order.payment_receipt %}
        <div class="mb-3">
          <span class="text-success font-weight-bold">
            <i class="fas fa-check-circle"></i>
            <!-- picture -->
            已於 {{ order.payment_receipt_uploaded_at|date:"M d,H:i"}}
            上傳過證明
          </span>
          <br />
          <a
            href="{{ order.payment_receipt.url}}"
            class="btn btn-link btn-sm p-0 text-info"
            target="_blank"
          >
            <i class="fas fa-image"></i> 查看目前圖片
          </a>
        </div>
        {% endif %}
        <!-- Payment_receipt Form -->
        <form
          action="{% url 'orders:payment_receipt' order.id %}"
          class="d-flex align-center"
          method="POST"
          enctype="multipart/form-data"
          onSubmit="return confirmUpload('{{order.payment_receipt}}','{{order.id}}')"
        >
          {% csrf_token %}
          <div class="custom-file custom-file-sm mr-2">
            <input
              type="file"
              class="custom-file-input"
              name="payment_proof"
              type="file"
              id="proof{{order.id}}"
              accept="image/*"
              style="cursor: pointer"
              required
            />
            <label
              for="proof{{order.id}}"
              class="custom-file-label text-truncate"
            >
              {% if order.payment_receipt %}
              <!---->
              重新選擇檔案
              <!---->
              {% else %}
              <!---->
              選擇入數紙
              <!---->
              {% endif %}
            </label>
          </div>
          <button
            class="btn btn-sm {% if order.payment_receipt %} btn-outline-secondary {% else %} btn-primary {% endif %}"
            type="submit"
          >
            {% if order.payment_receipt %}覆蓋上傳{% else %}上傳{% endif %}
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
    <!---->
    {% else %}
    <!---->
    <p class="text-muted">暫時冇任何訂單紀錄。</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("change", function (e) {
    const input = e.target;
    if (input && input.classList.contains("custom-file-input")) {
      if (input.files && input.files.length > 0) {
        const fileName = input.files[0].name;
        const label = input.nextElementSibling;
        label.textContent = fileName;
      }
    }
  });

  function confirmUpload(hasExisting, orderId) {
    if (hasExisting && hasExisting !== "None" && hasExisting !== "") {
      return confirm("你之前已經上傳過入數證明，確定要用新檔案覆蓋嗎？");
    }
    return true;
  }
</script>
{% endblock %}
